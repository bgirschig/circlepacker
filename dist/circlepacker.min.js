!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):i.CirclePacker=t()}(this,function(){"use strict";function i(i,t){i.postMessage(JSON.stringify(t))}function t(i){return i.data?JSON.parse(i.data):{}}function e(i){return i&&i.id&&i.radius&&i.position&&"number"==typeof i.position.x&&"number"==typeof i.position.y}function r(i){return i&&"number"==typeof i.width&&"number"==typeof i.height}var o=function(i){void 0===i&&(i={}),this.worker=new Worker(URL.createObjectURL(new Blob(['function sendWorkerMessage(i,e){i.postMessage(JSON.stringify(e))}function processWorkerMessage(i){return i.data?JSON.parse(i.data):{}}function receivedMessage(i){var e=processWorkerMessage(i),t=e.type,r=e.message;"bounds"===t&&circleManager.setBounds(r),"target"===t&&setTarget(r),"addcircles"===t&&addCircles(r),"removecircle"===t&&circleManager.removeCircle(r),"update"===t&&update(),"dragstart"===t&&circleManager.dragStart(r.id,r.position),"drag"===t&&circleManager.drag(r.id,r.position),"dragend"===t&&circleManager.dragEnd(r.id),"pincircle"===t&&circleManager.pinCircle(r),"unpincircle"===t&&circleManager.unpinCircle(r),"centeringpasses"===t&&"number"==typeof r&&r>0&&(circleManager.numberOfCenteringPasses=r),"collisionpasses"===t&&"number"==typeof r&&r>0&&(circleManager.numberOfCollisionPasses=r),"damping"===t&&"number"==typeof r&&r>0&&(circleManager.damping=r)}function updatePage(i,e){sendWorkerMessage(self,{type:i,message:e})}function addCircles(i){Array.isArray(i)&&i.length&&i.forEach(circleManager.addCircle.bind(circleManager))}function setTarget(i){i&&"number"==typeof i.x&&"number"==typeof i.y&&circleManager.setTarget(new Vector(i))}function update(){circleManager.updatePositions(),sendPositions()}function sendPositions(){var i=circleManager.allCircles.reduce(function(i,e){return i[e.id]={position:e.position,previousPosition:e.previousPosition,radius:e.radius,delta:e.delta},i},{});updatePage("move",i)}var Vector=function(i,e){"object"==typeof i?(this.x=i.x,this.y=i.y):(this.x=i,this.y=e)};Vector.prototype.cp=function(){return new Vector(this.x,this.y)},Vector.prototype.mul=function(i){return this.x*=i,this.y*=i,this},Vector.prototype.normalize=function(){var i=this.length();return this.x/=i,this.y/=i,this},Vector.prototype.length=function i(){var i=Math.sqrt(this.x*this.x+this.y*this.y);return i<.005&&i>-.005?1e-6:i},Vector.prototype.distance=function(i){var e=this.x-i.x,t=this.y-i.y;return Math.sqrt(e*e+t*t)},Vector.prototype.distanceSquared=function(i){var e=this.x-i.x,t=this.y-i.y;return e*e+t*t};var PackedCircle=function(i,e,t,r){void 0===t&&(t=0),void 0===r&&(r=0),this.id=i,this.targetPosition=new Vector(0,0),this.position=new Vector(t,r),this.previousPosition=new Vector(t,r),this.positionWithOffset=new Vector(t,r),this.previousPositionWithOffset=new Vector(t,r),this.setRadius(e)},prototypeAccessors={delta:{}};PackedCircle.prototype.setPosition=function(i){this.previousPosition=this.position,this.position=i.cp()},PackedCircle.prototype.distanceSquaredFromTargetPosition=function(){var i=this.position.distanceSquared(this.targetPosition);return i<this.radiusSquared},PackedCircle.prototype.setRadius=function(i){this.radius=i,this.radiusSquared=i*i,this.originalRadius=i},prototypeAccessors.delta.get=function(){return new Vector(this.position.x-this.previousPosition.x,this.position.y-this.previousPosition.y)},Object.defineProperties(PackedCircle.prototype,prototypeAccessors);var PackedCircleManager=function(){this.allCircles=[],this.pinnedCircleIds=[],this.desiredTarget=new Vector(0,0),this.bounds={left:0,top:0,right:0,bottom:0},this.damping=.025,this.numberOfCenteringPasses=1,this.numberOfCollisionPasses=3};PackedCircleManager.prototype.setBounds=function(i){"number"==typeof i.left&&(this.bounds.left=i.left),"number"==typeof i.right&&(this.bounds.right=i.right),"number"==typeof i.top&&(this.bounds.top=i.top),"number"==typeof i.bottom&&(this.bounds.bottom=i.bottom),"number"==typeof i.width&&(this.bounds.right=this.bounds.left+i.width),"number"==typeof i.height&&(this.bounds.bottom=this.bounds.top+i.height)},PackedCircleManager.prototype.addCircle=function(i){i instanceof PackedCircle||(i=new PackedCircle(i.id,i.radius,i.position.x,i.position.y)),this.allCircles.push(i),i.targetPosition=this.desiredTarget.cp()},PackedCircleManager.prototype.removeCircle=function(i){for(var e=this,t=this.allCircles.reduce(function(e,t,r){return t.id===i&&e.push(r),e},[]),r=t.length-1;r>=0;r--)e.allCircles.splice(t[r],1)},PackedCircleManager.prototype.updatePositions=function(){for(var i=this,e=this.allCircles,t=e.length,r=0;r<t;++r){var s=e[r];s.previousPosition=s.position.cp()}this.desiredTarget&&this.pushAllCirclesTowardTarget(this.desiredTarget),this.handleCollisions();for(var o=0;o<t;++o){var n=e[o];i.handleBoundaryForCircle(n)}},PackedCircleManager.prototype.pushAllCirclesTowardTarget=function(i){for(var e=this,t=new Vector(0,0),r=this.draggedCircle,s=this.allCircles,o=s.length,n=0;n<this.numberOfCenteringPasses;n++)for(var a=0;a<o;a++){var c=s[a],d=c===r||e.isCirclePinned(c.id);d||(t.x=c.position.x-i.x,t.y=c.position.y-i.y,t.mul(e.damping),c.position.x-=t.x,c.position.y-=t.y)}},PackedCircleManager.prototype.handleCollisions=function(){for(var i=this,e=new Vector(0,0),t=this.draggedCircle,r=this.allCircles,s=r.length,o=0;o<this.numberOfCollisionPasses;o++)for(var n=0;n<s;n++)for(var a=r[n],c=n+1;c<s;c++){var d=r[c],l=i.isCirclePinned(a.id),p=i.isCirclePinned(d.id),u=a===t||l,h=d===t||p;if(!(a===d||u&&h)){var g=d.position.x-a.position.x,f=d.position.y-a.position.y,C=1.08*(a.radius+d.radius),y=a.position.distanceSquared(d.position);if(y<C*C-.02){e.x=g,e.y=f,e.normalize();var P=.5*(C-Math.sqrt(y));e.mul(P),h||(u&&e.mul(2.2),d.position.x+=e.x,d.position.y+=e.y),u||(h&&e.mul(2.2),a.position.x-=e.x,a.position.y-=e.y)}}}},PackedCircleManager.prototype.handleBoundaryForCircle=function(i){var e=i.position.x,t=i.position.y,r=i.radius,s=!1;e+r>=this.bounds.right?(i.position.x=this.bounds.right-r,s=!0):e-r<this.bounds.left&&(i.position.x=this.bounds.left+r,s=!0),t+r>this.bounds.bottom?(i.position.y=this.bounds.bottom-r,s=!0):t-r<this.bounds.top&&(i.position.y=this.bounds.top+r,s=!0),s&&i===this.draggedCircle&&(this.draggedCircle=null)},PackedCircleManager.prototype.setDraggedCircle=function(i){this.draggedCircle&&this.draggedCircle!==i&&(this.draggedCircle.radius=this.draggedCircle.originalRadius),this.draggedCircle=i},PackedCircleManager.prototype.dragStart=function(i){var e=this.allCircles.filter(function(e){return e.id===i})[0];this.setDraggedCircle(e)},PackedCircleManager.prototype.dragEnd=function(i){this.draggedCircle&&this.setDraggedCircle(null)},PackedCircleManager.prototype.drag=function(i,e){this.draggedCircle&&e&&(this.draggedCircle.position.x=e.x,this.draggedCircle.position.y=e.y)},PackedCircleManager.prototype.isCirclePinned=function(i){return this.pinnedCircleIds.includes(i)},PackedCircleManager.prototype.pinCircle=function(i){this.isCirclePinned(i)||this.pinnedCircleIds.push(i)},PackedCircleManager.prototype.unpinCircle=function(i){this.pinnedCircleIds=this.pinnedCircleIds.filter(function(e){return e!==i})},PackedCircleManager.prototype.setTarget=function(i){this.desiredTarget=i},self.addEventListener("message",receivedMessage);var circleManager=new PackedCircleManager;'],{type:"text/javascript"}))),this.worker.addEventListener("message",this.receivedWorkerMessage.bind(this)),this.isContinuousModeActive="boolean"!=typeof i.continuousMode||i.continuousMode,this.onMoveStart=i.onMoveStart||null,this.onMove=i.onMove||null,this.onMoveEnd=i.onMoveEnd||null,i.centeringPasses&&this.setCenteringPasses(i.centeringPasses),i.collisionPasses&&this.setCollisionPasses(i.collisionPasses),this.addCircles(i.circles||[]),this.setBounds(i.bounds||{width:100,height:100}),this.setTarget(i.target||{x:50,y:50}),this.isLooping=!1,this.areItemsMoving=!0,this.animationFrameId=NaN,this.initialized=!0,this.isContinuousModeActive&&this.startLoop()};return o.prototype.receivedWorkerMessage=function(i){var e=t(i);if("move"===e.type){var r=e.message;this.areItemsMoving=this.hasItemMoved(r)}this.updateListeners(e)},o.prototype.updateWorker=function(t,e){i(this.worker,{type:t,message:e})},o.prototype.updateListeners=function(i){var t=i.type,e=i.message;"movestart"===t&&"function"==typeof this.onMoveStart&&this.onMoveStart(e),"move"===t&&"function"==typeof this.onMove&&this.onMove(e),"moveend"===t&&"function"==typeof this.onMoveEnd&&this.onMoveEnd(e)},o.prototype.addCircles=function(i){if(Array.isArray(i)&&i.length){var t=i.filter(e);t.length&&this.updateWorker("addcircles",t)}this.startLoop()},o.prototype.addCircle=function(i){this.addCircles([i])},o.prototype.removeCircle=function(i){i&&(i.id?this.updateWorker("removecircle",i.id):this.updateWorker("removecircle",i),this.startLoop())},o.prototype.pinCircle=function(i){i&&(i.id?this.updateWorker("pincircle",i.id):this.updateWorker("pincircle",i),this.startLoop())},o.prototype.unpinCircle=function(i){i&&(i.id?this.updateWorker("unpincircle",i.id):this.updateWorker("unpincircle",i),this.startLoop())},o.prototype.setBounds=function(i){r(i)&&(this.updateWorker("bounds",i),this.startLoop())},o.prototype.setTarget=function(i){this.updateWorker("target",i),this.startLoop()},o.prototype.setCenteringPasses=function(i){this.updateWorker("centeringpasses",i)},o.prototype.setCollisionPasses=function(i){this.updateWorker("collisionpasses",i)},o.prototype.setDamping=function(i){this.updateWorker("damping",i)},o.prototype.update=function(){this.updateWorker("update")},o.prototype.dragStart=function(i){this.updateWorker("dragstart",{id:i}),this.startLoop()},o.prototype.drag=function(i,t){this.updateWorker("drag",{id:i,position:t}),this.startLoop()},o.prototype.dragEnd=function(i){this.updateWorker("dragend",{id:i}),this.startLoop()},o.prototype.updateLoop=function(){this.update(),this.isLooping&&(this.areItemsMoving?this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)):this.stopLoop())},o.prototype.startLoop=function(){!this.isLooping&&this.initialized&&this.isContinuousModeActive&&(this.isLooping=!0,this.isContinuousModeActive&&(this.areItemsMoving=!0),this.updateListeners("movestart"),this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)))},o.prototype.stopLoop=function(){this.isLooping&&(this.isLooping=!1,this.updateListeners("moveend"),cancelAnimationFrame(this.animationFrameId))},o.prototype.hasItemMoved=function(i){var t=!1;for(var e in i)Math.abs(i[e].delta.x)>.005&&Math.abs(i[e].delta.y)>.005&&(t=!0);return t},o.prototype.destroy=function(){this.worker&&this.worker.terminate(),this.stopLoop(),this.onMove=null,this.onMoveStart=null,this.onMoveEnd=null},o});